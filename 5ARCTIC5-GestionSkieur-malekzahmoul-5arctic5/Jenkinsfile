pipeline {
  agent any

  environment {
    // Credentials
    NEXUS_CREDENTIALS  = credentials('nexus-admin-credentials')
    DOCKER_CREDENTIALS = credentials('docker-hub-credentials')

    // Build/Image vars
    RELEASE_VERSION = "1.0"
    registry = "malekzahmoul20971/gestion-station-ski"
    IMAGE_TAG = "${RELEASE_VERSION}-${env.BUILD_NUMBER}"
    dockerImage = ""

    // Project subfolder (where pom.xml is)
    PROJECT_DIR = "5ARCTIC5-GestionSkieur-malekzahmoul-5arctic5"
  }

  stages {

    // Jenkins already does "Checkout SCM" automatically when using Pipeline from SCM
    stage('Clean') {
      steps {
        echo 'Cleaning the workspace...'
        dir("${env.PROJECT_DIR}") {
          sh 'mvn clean'
        }
      }
    }

    stage('Test') {
      steps {
        dir("${env.PROJECT_DIR}") {
          sh 'mvn test'
        }
      }
    }

    stage('Build') {
      steps {
        dir("${env.PROJECT_DIR}") {
          sh 'mvn install -Dmaven.test.skip=true'
        }
      }
    }

    stage('SonarQube Analysis') {
      steps {
        dir("${env.PROJECT_DIR}") {
          withCredentials([string(credentialsId: 'sonar-token', variable: 'SONAR_TOKEN')]) {
            sh '''
              mvn sonar:sonar \
                -Dsonar.login=$SONAR_TOKEN \
                -Dsonar.ws.timeout=120 \
                -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
            '''
          }
        }
      }
    }

    stage('Deploy to Nexus') {
      steps {
        dir("${env.PROJECT_DIR}") {
          withCredentials([usernamePassword(credentialsId: 'nexus-admin-credentials',
                                            usernameVariable: 'NEXUS_USERNAME',
                                            passwordVariable: 'NEXUS_PASSWORD')]) {
            sh '''
              cat > settings.xml <<EOF
    <settings>
      <servers>
        <server>
          <id>deploymentRepo</id>
          <username>${NEXUS_USERNAME}</username>
          <password>${NEXUS_PASSWORD}</password>
        </server>
      </servers>
    </settings>
    EOF

              mvn -s settings.xml deploy -Dmaven.test.skip=true \
                -DaltDeploymentRepository=deploymentRepo::default::http://localhost:8081/repository/malekzahmoul/
            '''
          }
        }
      }
    }


    stage('Building our image') {
      steps {
        dir("${env.PROJECT_DIR}") {
          sh "docker build -t ${registry}:${IMAGE_TAG} ."
        }
      }
    }

    stage('Push to DockerHub') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'docker-hub-credentials',
                                          usernameVariable: 'DOCKER_USERNAME',
                                          passwordVariable: 'DOCKER_PASSWORD')]) {
          sh '''
            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
            docker push '"${registry}:${IMAGE_TAG}"'
          '''
        }
      }
    }


    stage('Deploy with Docker Compose') {
      steps {
        dir("${env.PROJECT_DIR}") {
          script {
            sh 'docker compose down || true'
            sh 'docker compose up -d'
            sh 'sleep 30'
            sh 'docker compose ps'
          }
        }
      }
    }
  }

  post {
    success {
      echo 'Build finished successfully!'
      // Email disabled until SMTP is configured
      // mail to: 'malekzahmoul20@gmail.com',
      //      subject: "Jenkins Job Successful: ${env.JOB_NAME} [${env.BUILD_NUMBER}]",
      //      body: "Good news! The job ${env.JOB_NAME} [${env.BUILD_NUMBER}] has finished successfully."
    }
    failure {
      echo 'Build failed!'
      // Email disabled until SMTP is configured
      // mail to: 'malekzahmoul20@gmail.com',
      //      subject: "Jenkins Job Failed: ${env.JOB_NAME} [${env.BUILD_NUMBER}]",
      //      body: "Sorry, the job ${env.JOB_NAME} [${env.BUILD_NUMBER}] has failed. Please check the console output."
    }
  }
}
